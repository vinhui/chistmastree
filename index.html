<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <title>Christmas Tree</title>
    <link rel="shortcut icon" type="image/png" href="http://www.iconarchive.com/download/i81314/icons8/christmas-flat-color/christmas-tree.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="stylesheet" href="https://bootswatch.com/lumen/bootstrap.css" media="screen">
    <link rel="stylesheet" href="https://bootswatch.com/assets/css/custom.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <div class="row">
                <div class="col-lg-12">
                    <h1>Christmas Tree Control</h1>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12 alert alert-danger">
                <strong>Oh snap!</strong><br />Failed to connect to the tree
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4">
                <div class="panel panel-default">
                    <div class="panel-heading">Set Sequence</div>
                    <div class="panel-body">
                        <div class="btn-group-vertical" id="sequences">
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="panel panel-default">
                    <div class="panel-heading">Sequence Editor</div>
                    <div class="panel-body">
                        <div class="row">
                            <div class="col-lg-12">
                                <ul class="list-group strip-tester"></ul>
                            </div>
                        </div>
                        <div class="row">
                            <label for="led-count" class="col-lg-2 control-label">Led count</label>
                            <div class="col-lg-2">
                                <input type="number" name="led-count" id="led-count" data-cip-id="led-count" value="30" />
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <textarea style="width: 100%" rows="20" name="sequence-data">
#startID(0-255),endID(0-255),r(0-255),g(0-255),b(0-255),delay in ms
0,0,0,255,0,100
1,1,255,0,0,100
2,2,0,255,0,100
3,3,255,0,0,100
4,4,0,255,0,100
5,5,255,0,0,100
6,6,0,255,0,100
7,7,255,0,0,100
8,8,0,255,0,100
9,9,255,0,0,100
10,10,0,255,0,100
11,11,255,0,0,100
12,12,0,255,0,100
13,13,255,0,0,100
14,14,0,255,0,100
15,15,255,0,0,100
16,16,0,255,0,100
17,17,255,0,0,100
18,18,0,255,0,100
19,19,255,0,0,100
20,20,0,255,0,100
21,21,255,0,0,100
22,22,0,255,0,100
23,23,255,0,0,100
24,24,0,255,0,100
25,25,255,0,0,100
26,26,0,255,0,100
27,27,255,0,0,100
28,28,0,255,0,100
29,29,255,0,0,100

#Disable all lights
0,255,0,0,0,5</textarea>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-12">
                                <button class="btn btn-default pull-left" data-toggle="modal" data-target="#generateModal">Generator</button>
                                <button class="btn btn-default pull-right" id="run-sequence-remote">Run on tree</button>
                                <button class="btn btn-success pull-right" id="run-sequence">Test</button>
                                <button class="btn btn-default pull-right" id="stop-sequence">Stop</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="generateModal" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h2 class="modal-title">Generate</h2>
                    </div>
                    <div class="modal-body">
                        <div class="form-group form-group-sm">
                            <div class="row">
                                <label for="generate-startled" class="col-sm-2">Start LED</label>
                                <input type="number" class="col-sm-2" id="generate-startled" value="0" min="0" max="255" step="1"/>
                            </div>
                            <div class="row">
                                <label for="generate-endled" class="col-sm-2">End LED</label>
                                <input type="number" class="col-sm-2" id="generate-endled" value="255" min="0" max="255" step="1"/>
                            </div>
                            <div class="row">
                                <label for="generate-color-1" class="col-sm-2">Color #1</label>
                                <input type="color" class="col-sm-2 generate-color" id="generate-color-1" value="#000000"/>
                            </div>
                            <div class="row">
                                <label for="generate-color-2" class="col-sm-2">Color #2</label>
                                <input type="color" class="col-sm-2 generate-color" id="generate-color-2" value="#ffffff"/>
                                <button class="col-sm-1 generate-color-add">+</button>
                            </div>
                            <div class="row">
                                <label for="generate-duration" class="col-sm-2">Duration <span class="small">(ms)</span></label>
                                <input type="number" class="col-sm-2" id="generate-duration" value="5000" step="10" min="10" />
                            </div>
                            <div class="row">
                                <label for="generate-step" class="col-sm-2">Step <span class="small">(ms)</span></label>
                                <input type="number" class="col-sm-2" id="generate-step" value="10" step="10" min="10" />
                            </div>
                        </div>
                        <div>
                            <h3>Output:</h3>
                            <textarea class="form-control" id="generate-output" rows="5"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="generate-button">Generate</button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        var ledCount = 30;
        var run = false;
        var sequence = [];
        var currentStep = 0;

        var sequenceData = {
            ledStartID: 0,
            ledEndID: 0,
            red: 0,
            green: 0,
            blue: 0,
            delay: 10
        };

        $(".alert").hide();

        $("#sequences").on('click', 'button', function () {
            url = "/set/" + $(this).text();
            if($(this).hasClass("btn-primary")) {
                url = "/stop/";
            }
            $.get(url, function (data, status) {
                updateSequences();
                connectionSuccess();
            })
            .fail(connectionFailed);
        });

        $(".row").on('click', '#run-sequence', function () {
            ledCount = parseInt($("input[name='led-count']").val());
            createLedStrip();
            sequence = parseSequence($("textarea[name='sequence-data']").val());
            runDelta = run;
            run = true;
            currentStep = 0;

            if (!runDelta)
                runSequence();
        });

        $(".row").on('click', '#run-sequence-remote', function () {
            $.ajax({
                type: "POST",
                url: "/set/",
                data: $("textarea[name='sequence-data']").val()
            }, function(){
                connectionSuccess();
            })
            .fail(connectionFailed);
        });

        $(".row").on('click', '#stop-sequence', function () {
            run = false;

            setLedRangeColor(0, ledCount, 0, 0, 0);
        });

        createLedStrip();
        updateSequences();
        setInterval(updateSequences, 5000);

        function connectionFailed() {
            $(".alert").show();
        }

        function connectionSuccess() {
            $(".alert").hide();
        }

        function updateSequences() {
            $.get("/get/sequences/html", function (data, status) {
                $("#sequences").html(data);
                connectionSuccess();
            })
            .fail(connectionFailed);
        }

        function createLedStrip() {
            $(".strip-tester").html("");

            for (i = 0; i < ledCount; i++) {
                $(".strip-tester").append('<li class="list-group-item pull-left" style="padding:0px; width: 20px; height: 20px; background-color: black">' + i + '</li>');
            }
        }

        function parseSequence(data) {
            var output = [];
            var lines = data.split('\n');

            for (i = 0; i < lines.length; i++) {
                var line = lines[i].trim();

                if (line.slice(0, 1) != "#" && line != "") {
                    var data = line.split(',');

                    if (data.length == 6) {
                        var obj = Object.create(sequenceData);
                        obj.ledStartID = Math.max(parseInt(data[0]), 0);
                        obj.ledEndID = Math.min(parseInt(data[1]), ledCount);
                        obj.red = parseInt(data[2]);
                        obj.green = parseInt(data[3]);
                        obj.blue = parseInt(data[4]);
                        obj.delay = parseInt(data[5]);

                        output.push(obj);
                    }
                }
            }

            return output;
        }

        function runSequence() {
            if (currentStep >= sequence.length)
                currentStep = 0;

            setTimeout(function () {
                if (run) {
                    setLedRangeColor(
						sequence[currentStep].ledStartID,
						sequence[currentStep].ledEndID,
						sequence[currentStep].red,
						sequence[currentStep].green,
						sequence[currentStep].blue);
                    currentStep++;
                    runSequence();
                }
            }, sequence[Math.max(currentStep - 1, 0)].delay);
        }

        function setLedRangeColor(start, end, r, g, b) {
            if (start == end) {
                setLedColor(start, r, g, b);
            }
            else {
                for (i = Math.max(Math.min(start, end), 0) ; i < Math.min(Math.max(start, end), ledCount) ; i++) {
                    setLedColor(i, r, g, b);
                }
            }
        }

        function setLedColor(index, r, g, b) {
            $(".strip-tester li").eq(index).css("background-color", "rgb(" + r + "," + g + "," + b + ")");
        }


        $("#generate-button").click(function(){
            generateFade();
            $("#generate-output").effect("highlight");
        });
        function remGradientColor() {
            $(".generate-color:last").parent().remove();
            $(".generate-color-rem:last").show();
            $(".generate-color-add:last").show();
        }
        function addGradientColor() {
            $(".generate-color-rem").hide();
            $(".generate-color-add").hide();
            var index = $(".generate-color").length + 1;
            $(".generate-color:last").parent().after(`
                            <div class="row">
                                <label for="generate-color-`+index+`" class="col-sm-2">Color #`+index+`</label>
                                <input type="color" class="col-sm-2 generate-color" id="generate-color-`+index+`" value="#000000"/>
                                <button class="col-sm-1 generate-color-rem">-</button>
                                <button class="col-sm-1 generate-color-add">+</button>
                            </div>`);
        }
        $(document).on('click', '.generate-color-add', function () {
            addGradientColor();
        });
        $(document).on('click', '.generate-color-rem', function () {
            remGradientColor();
        });
        function generateFade() {
            var startLed = parseInt($("#generate-startled").val());
            var endLed = parseInt($("#generate-endled").val());
            var duration = parseInt($("#generate-duration").val());
            var step = parseInt($("#generate-step").val());
            var colors = $(".generate-color").map(function() { return $(this).val() });

            var output = "";

            var section = duration / (colors.length - 1);
            for (var n = 0; n < colors.length - 1; n++) {
                for (var i = 0; i < section; i += step) {
                    var t = i / section;
                    var color = lerpColor(colors[n], colors[n + 1], t);
                    var rgb = hexToRgb(color);
                    output += startLed+","+endLed+","+rgb[0]+","+rgb[1]+","+rgb[2]+","+step+"\n";
                }
            }
        
           var endrgb = hexToRgb(colors[colors.length - 1]);
           output += startLed+","+endLed+","+endrgb[0]+","+endrgb[1]+","+endrgb[2]+","+step;
           $("#generate-output").val(output);
        }

        // https://gist.github.com/rosszurowski/67f04465c424a9bc0dae
        function lerpColor(a, b, amount) { 
            var ah = parseInt(a.replace(/#/g, ''), 16),
                ar = ah >> 16, ag = ah >> 8 & 0xff, ab = ah & 0xff,
                bh = parseInt(b.replace(/#/g, ''), 16),
                br = bh >> 16, bg = bh >> 8 & 0xff, bb = bh & 0xff,
                rr = ar + amount * (br - ar),
                rg = ag + amount * (bg - ag),
                rb = ab + amount * (bb - ab);

            return '#' + ((1 << 24) + (rr << 16) + (rg << 8) + rb | 0).toString(16).slice(1);
        }

        // https://stackoverflow.com/questions/21646738/convert-hex-to-rgba
        function hexToRgb(hex) {
            var c;
            if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){
                c = hex.substring(1).split('');
                if(c.length== 3){
                    c= [c[0], c[0], c[1], c[1], c[2], c[2]];
                }
                c= '0x'+c.join('');
                return [(c>>16)&255, (c>>8)&255, c&255];
            }
            throw new Error('Bad Hex');
        }
    </script>
</body>
</html>
